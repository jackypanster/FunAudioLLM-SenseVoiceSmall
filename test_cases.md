**测试用例文档**

**1. 引言**

本文档定义了 FunAudioLLM/SenseVoiceSmall 语音转录服务的测试用例。这些测试旨在验证系统的功能正确性、性能、可靠性和易用性。测试将覆盖 API 接口、核心语音识别逻辑以及部署方面。

**2. 测试范围**

*   **API 接口测试**: 验证 `/asr_pure` 端点的行为，包括成功请求、错误处理和不同输入参数。
*   **功能测试**: 验证语音转录的准确性（基于样本）、对不同音频格式的支持情况。
*   **错误处理测试**: 验证系统对无效输入、模型错误、资源问题的处理。
*   **性能测试 (初步)**: 评估单个请求的处理时间。
*   **部署测试**: 验证服务是否能按照部署文档成功启动和运行。

**3. 测试环境**

*   **服务器**: 与部署环境一致 (Ubuntu 24.04, NVIDIA GPU, CUDA 12.4)。
*   **客户端**: 任何可以发送 HTTP POST 请求的工具，如 `curl`、Postman，或 Python `requests` 库。
*   **测试音频**: 准备一组包含不同说话人、口音、背景噪音、时长和格式（.wav, .mp3 等，如果支持）的音频样本。
    *   `short_clear_speech.wav`: 短促清晰的语音。
    *   `long_speech.wav`: 较长的语音片段。
    *   `noisy_speech.wav`: 带背景噪音的语音。
    *   `various_accents.wav`: 不同口音的语音（如果能获取到）。
    *   `empty.wav`: 空音频文件。
    *   `corrupted.wav`: 损坏的音频文件。
    *   `unsupported_format.flac`: 不支持的音频格式文件。
    *   `large_file.wav`: 超出预期大小限制的音频文件 (用于测试大小限制)。

**4. 测试用例**

**4.1. API 接口测试 (`/asr_pure`)**

| 测试用例 ID | 描述                                                                 | 测试步骤                                                                                                | 预期结果                                                                                                                               | 状态 (Pass/Fail) | 备注                                           |
|-------------|----------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|------------------|------------------------------------------------|
| API-001     | 成功转录 - WAV 文件                                                    | `curl -X POST "http://<host>:8000/asr_pure" -F "file=@short_clear_speech.wav"`                          | HTTP 200 OK。JSON 响应包含 `{"text": "<转录文本>", "status": "success", "processing_time_ms": <数字>}`。转录文本与预期大致相符。 |                  | 文本准确性需人工评估                             |
| API-002     | 成功转录 - MP3 文件 (如果支持)                                           | `curl -X POST "http://<host>:8000/asr_pure" -F "file=@short_clear_speech.mp3"`                          | HTTP 200 OK。JSON 响应同 API-001。                                                                                                   |                  | 确认MP3是否在支持列表                            |
| API-003     | 错误 - 未提供文件                                                        | `curl -X POST "http://<host>:8000/asr_pure"`                                                            | HTTP 422 Unprocessable Entity。响应体包含 FastAPI 的标准校验错误信息。                                                                 |                  |                                                |
| API-004     | 错误 - 文件字段名错误                                                    | `curl -X POST "http://<host>:8000/asr_pure" -F "audio_data=@short_clear_speech.wav"`                    | HTTP 422 Unprocessable Entity。                                                                                                        |                  |                                                |
| API-005     | 错误 - 不支持的音频格式                                                  | `curl -X POST "http://<host>:8000/asr_pure" -F "file=@unsupported_format.flac"`                       | HTTP 400 Bad Request (或具体错误码)。JSON 响应 `{"detail": "无效的音频文件或格式不支持。", "status": "error"}` (或类似消息)。     |                  |                                                |
| API-006     | 错误 - 空音频文件                                                        | `curl -X POST "http://<host>:8000/asr_pure" -F "file=@empty.wav"`                                       | HTTP 400 Bad Request (或具体错误码)。错误信息指明文件问题。                                                                              |                  | 具体行为取决于模型如何处理空音频                   |
| API-007     | 错误 - 损坏的音频文件                                                    | `curl -X POST "http://<host>:8000/asr_pure" -F "file=@corrupted.wav"`                                   | HTTP 400 Bad Request (或具体错误码)。错误信息指明文件损坏或无法处理。                                                                      |                  |                                                |
| API-008     | 错误 - 文件过大 (如果配置了大小限制)                                       | `curl -X POST "http://<host>:8000/asr_pure" -F "file=@large_file.wav"`                                  | HTTP 413 Request Entity Too Large (如果 Uvicorn 或反向代理配置了限制) 或应用层面 400。错误信息指明文件过大。                           |                  | 确认是否配置了大小限制                           |
| API-009     | 请求方法错误 - GET                                                       | `curl -X GET "http://<host>:8000/asr_pure"`                                                             | HTTP 405 Method Not Allowed。                                                                                                            |                  |                                                |

**4.2. 功能测试 (语音识别核心)**

| 测试用例 ID | 描述                                 | 测试步骤                                                                                                | 预期结果                                                                         | 状态 (Pass/Fail) | 备注                                                                 |
|-------------|--------------------------------------|---------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|------------------|----------------------------------------------------------------------|
| FUNC-001    | 转录清晰短语音 (WAV)                 | 使用 API-001 的方式，评估 `short_clear_speech.wav` 的转录文本。                                             | 转录文本与实际语音内容高度匹配 (例如，词错误率 WER 低于某个阈值)。                     |                  | 需要预先准备好该音频的"标准答案"文本。WER 手动或脚本计算。                 |
| FUNC-002    | 转录较长语音 (WAV)                   | 使用 `long_speech.wav` 进行测试。                                                                       | 转录文本连贯，主要内容被识别。                                                       |                  |                                                                      |
| FUNC-003    | 转录带噪音语音 (WAV)                 | 使用 `noisy_speech.wav` 进行测试。                                                                      | 转录文本质量可能下降，但关键信息应仍可识别。                                         |                  | 评估抗噪能力。                                                         |
| FUNC-004    | 转录不同口音语音 (如果适用)        | 使用 `various_accents.wav` 进行测试。                                                                   | 模型对不同口音有一定的鲁棒性。                                                       |                  | 取决于模型训练数据。                                                   |
| FUNC-005    | 结果包含处理时间                     | 检查 API-001 等成功请求的响应中 `processing_time_ms` 字段是否为正数。                                       | `processing_time_ms` 是一个合理的正数值。                                            |                  |                                                                      |

**4.3. 错误处理与健壮性测试**

| 测试用例 ID | 描述                                                               | 测试步骤                                                                                       | 预期结果                                                                                             | 状态 (Pass/Fail) | 备注                                                               |
|-------------|--------------------------------------------------------------------|------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|------------------|--------------------------------------------------------------------|
| ERR-001     | 模型加载失败 (模拟)                                                  | (需要特殊设置) 尝试启动服务时，将模型路径配置为一个不存在的路径。                                  | 服务启动失败，并在日志中记录 `ModelLoadError` 或类似错误。如果服务已启动，请求 `/asr_pure` 应返回 500 错误。 |                  | 测试模型加载失败时的服务行为。                                         |
| ERR-002     | GPU 不可用 (模拟，如果可能)                                          | (需要特殊设置) 如果模型配置为在特定 GPU 运行，尝试在 GPU 被其他进程占满或驱动出问题时启动服务/发送请求。 | 服务启动失败或请求返回 500 错误，日志记录 GPU 相关错误。                                                   |                  | 较难模拟，取决于具体设置。                                           |
| ERR-003     | 并发请求 (初步)                                                    | 同时发送少量 (例如 2-4个) 有效的音频文件到 `/asr_pure`。                                         | 所有请求都应在合理时间内得到成功响应 (假设服务器资源足够)。服务不应崩溃。                                      |                  | 不是严格的压力测试，仅初步检查并发处理。                               |

**4.4. 部署与环境测试**

| 测试用例 ID | 描述                                         | 测试步骤                                                                 | 预期结果                                                                     | 状态 (Pass/Fail) | 备注                                     |
|-------------|----------------------------------------------|--------------------------------------------------------------------------|------------------------------------------------------------------------------|------------------|------------------------------------------|
| DEPLOY-001  | 按照部署文档成功启动服务                       | 完整执行 `deployment_guide.md` 中的步骤。                                  | 服务成功启动，`systemctl status sensevoice_asr` (如果使用 systemd) 显示 active (running)。 |                  |                                          |
| DEPLOY-002  | 服务监听在配置的端口和地址                     | 使用 `netstat -tulnp | grep <配置的端口>` 检查。                                | 服务在 `0.0.0.0:<配置的端口>` 上监听。                                           |                  |                                          |
| DEPLOY-003  | 虚拟环境和依赖正确安装                       | 在激活的 `.venv` 中，检查 `uv pip list` 是否包含所有必要的依赖项。           | 所有在 `requirements.txt` 或 `pyproject.toml` 中列出的依赖项都已安装。             |                  |                                          |
| DEPLOY-004  | 模型文件路径和服务访问权限                     | 确认运行服务的用户对 `/home/llm/model/iic/SenseVoiceSmall` 具有读取权限。      | 服务能够成功加载模型。                                                           |                  |                                          |
| DEPLOY-005  | 服务日志可访问且包含启动信息                   | 查看 `journalctl -u sensevoice_asr` (如果使用 systemd) 或 uvicorn 输出。      | 日志中包含服务启动、模型加载等信息。                                               |                  |                                          |

**5. 性能基准测试 (初步)**

| 测试用例 ID | 描述                                   | 测试步骤                                                                                    | 预期结果/指标                                                                    | 状态 (Pass/Fail) | 备注                                         |
|-------------|----------------------------------------|---------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|------------------|----------------------------------------------|
| PERF-001    | 单个短音频文件处理时间 (如 10 秒 WAV)      | 多次发送同一个 10 秒左右的清晰 WAV 文件到 `/asr_pure`，记录每次响应中的 `processing_time_ms`。 | 平均 `processing_time_ms` 应在一个可接受的范围内 (例如，低于 2-3 秒)。RTF (Real Time Factor) < 1。 |                  | RTF = processing_time / audio_duration       |
| PERF-002    | 单个中等长度音频文件处理时间 (如 1 分钟 WAV) | 多次发送同一个 1 分钟左右的清晰 WAV 文件到 `/asr_pure`，记录每次响应中的 `processing_time_ms`。 | 平均 `processing_time_ms`。RTF 保持较低水平。                                      |                  |                                              |

**6. 测试数据管理**

*   所有测试音频文件应统一存放，并有明确命名。
*   对于需要"标准答案"文本的测试用例 (如 FUNC-001)，应将标准答案与音频文件对应保存。

**7. 测试执行与报告**

*   每次执行测试后，记录每个测试用例的 Pass/Fail 状态及任何相关备注。
*   对于失败的用例，应记录详细的复现步骤、实际结果和日志信息，以便于问题排查。 